var Bird=function(){var i=this;THREE.Geometry.call(this);t(5,0,0);t(-5,-2,1);t(-5,0,0);t(-5,-2,-1);t(0,2,-6);t(0,2,6);t(2,0,0);t(-3,0,0);o(0,2,1);o(4,7,6);o(5,6,7);this.computeFaceNormals();function t(t,o,e){i.vertices.push(new THREE.Vector3(t,o,e))}function o(t,o,e){i.faces.push(new THREE.Face3(t,o,e))}};Bird.prototype=Object.create(THREE.Geometry.prototype);Bird.prototype.constructor=Bird;var Boid=function(){var i=new THREE.Vector3,t,o=500,e=500,n=200,s,r=100,a=4,d=.1,c=false;this.position=new THREE.Vector3;this.velocity=new THREE.Vector3;t=new THREE.Vector3;this.setGoal=function(i){s=i};this.setAvoidWalls=function(i){c=i};this.setWorldSize=function(i,t,s){o=i;e=t;n=s};this.run=function(s){if(c){i.set(-o,this.position.y,this.position.z);i=this.avoid(i);i.multiplyScalar(5);t.add(i);i.set(o,this.position.y,this.position.z);i=this.avoid(i);i.multiplyScalar(5);t.add(i);i.set(this.position.x,-e,this.position.z);i=this.avoid(i);i.multiplyScalar(5);t.add(i);i.set(this.position.x,e,this.position.z);i=this.avoid(i);i.multiplyScalar(5);t.add(i);i.set(this.position.x,this.position.y,-n);i=this.avoid(i);i.multiplyScalar(5);t.add(i);i.set(this.position.x,this.position.y,n);i=this.avoid(i);i.multiplyScalar(5);t.add(i)}if(Math.random()>.5){this.flock(s)}this.move()};this.flock=function(i){if(s){t.add(this.reach(s,.005))}t.add(this.alignment(i));t.add(this.cohesion(i));t.add(this.separation(i))};this.move=function(){this.velocity.add(t);var i=this.velocity.length();if(i>a){this.velocity.divideScalar(i/a)}this.position.add(this.velocity);t.set(0,0,0)};this.checkBounds=function(){if(this.position.x>o)this.position.x=-o;if(this.position.x<-o)this.position.x=o;if(this.position.y>e)this.position.y=-e;if(this.position.y<-e)this.position.y=e;if(this.position.z>n)this.position.z=-n;if(this.position.z<-n)this.position.z=n};this.avoid=function(i){var t=new THREE.Vector3;t.copy(this.position);t.sub(i);t.multiplyScalar(1/this.position.distanceToSquared(i));return t};this.repulse=function(i){var o=this.position.distanceTo(i);if(o<150){var e=new THREE.Vector3;e.subVectors(this.position,i);e.multiplyScalar(.5/o);t.add(e)}};this.reach=function(i,t){var o=new THREE.Vector3;o.subVectors(i,this.position);o.multiplyScalar(t);return o};this.alignment=function(i){var t,o=new THREE.Vector3,e=0;for(var n=0,s=i.length;n<s;n++){if(Math.random()>.6)continue;t=i[n];distance=t.position.distanceTo(this.position);if(distance>0&&distance<=r){o.add(t.velocity);e++}}if(e>0){o.divideScalar(e);var a=o.length();if(a>d){o.divideScalar(a/d)}}return o};this.cohesion=function(i){var t,o,e=new THREE.Vector3,n=new THREE.Vector3,s=0;for(var a=0,c=i.length;a<c;a++){if(Math.random()>.6)continue;t=i[a];o=t.position.distanceTo(this.position);if(o>0&&o<=r){e.add(t.position);s++}}if(s>0){e.divideScalar(s)}n.subVectors(e,this.position);var h=n.length();if(h>d){n.divideScalar(h/d)}return n};this.separation=function(i){var t,o,e=new THREE.Vector3,n=new THREE.Vector3;for(var s=0,a=i.length;s<a;s++){if(Math.random()>.6)continue;t=i[s];o=t.position.distanceTo(this.position);if(o>0&&o<=r){n.subVectors(this.position,t.position);n.normalize();n.divideScalar(o);e.add(n)}}return e}};var SCREEN_WIDTH=window.innerWidth,SCREEN_HEIGHT=window.innerHeight,SCREEN_WIDTH_HALF=SCREEN_WIDTH/2,SCREEN_HEIGHT_HALF=SCREEN_HEIGHT/2;var camera,scene,renderer,birds,bird;var boid,boids;init();animate();function init(){camera=new THREE.PerspectiveCamera(75,SCREEN_WIDTH/SCREEN_HEIGHT,1,1e4);camera.position.z=450;scene=new THREE.Scene;birds=[];boids=[];for(var i=0;i<200;i++){boid=boids[i]=new Boid;boid.position.x=Math.random()*400-200;boid.position.y=Math.random()*400-200;boid.position.z=Math.random()*400-200;boid.velocity.x=Math.random()*2-1;boid.velocity.y=Math.random()*2-1;boid.velocity.z=Math.random()*2-1;boid.setAvoidWalls(true);boid.setWorldSize(500,500,400);bird=birds[i]=new THREE.Mesh(new Bird,new THREE.MeshBasicMaterial({color:Math.random()*16777215,side:THREE.DoubleSide}));bird.phase=Math.floor(Math.random()*62.83);scene.add(bird)}renderer=new THREE.CanvasRenderer;renderer.setClearColor(16777215);renderer.setPixelRatio(window.devicePixelRatio);renderer.setSize(SCREEN_WIDTH,SCREEN_HEIGHT);document.addEventListener("mousemove",onDocumentMouseMove,false);document.getElementById("birds-canvas-holder").appendChild(renderer.domElement);window.addEventListener("resize",onWindowResize,false)}function onWindowResize(){camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();renderer.setSize(window.innerWidth,window.innerHeight)}function onDocumentMouseMove(i){var t=new THREE.Vector3(i.clientX-SCREEN_WIDTH_HALF,-i.clientY+SCREEN_HEIGHT_HALF,0);for(var o=0,e=boids.length;o<e;o++){boid=boids[o];t.z=boid.position.z;boid.repulse(t)}}function animate(){requestAnimationFrame(animate);render()}function render(){for(var i=0,t=birds.length;i<t;i++){boid=boids[i];boid.run(boids);bird=birds[i];bird.position.copy(boids[i].position);color=bird.material.color;color.r=color.g=color.b=(500-bird.position.z)/1e3;bird.rotation.y=Math.atan2(-boid.velocity.z,boid.velocity.x);bird.rotation.z=Math.asin(boid.velocity.y/boid.velocity.length());bird.phase=(bird.phase+(Math.max(0,bird.rotation.z)+.1))%62.83;bird.geometry.vertices[5].y=bird.geometry.vertices[4].y=Math.sin(bird.phase)*5}renderer.render(scene,camera)}