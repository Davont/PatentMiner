THREE.SpriteCanvasMaterial=function(e){THREE.Material.call(this);this.type="SpriteCanvasMaterial";this.color=new THREE.Color(16777215);this.program=function(){};this.setValues(e)};THREE.SpriteCanvasMaterial.prototype=Object.create(THREE.Material.prototype);THREE.SpriteCanvasMaterial.prototype.constructor=THREE.SpriteCanvasMaterial;THREE.SpriteCanvasMaterial.prototype.isSpriteCanvasMaterial=true;THREE.SpriteCanvasMaterial.prototype.clone=function(){var e=new THREE.SpriteCanvasMaterial;e.copy(this);e.color.copy(this.color);e.program=this.program;return e};THREE.CanvasRenderer=function(e){console.log("THREE.CanvasRenderer",THREE.REVISION);e=e||{};var i=this,t,r,n,o=new THREE.Projector,a=e.canvas!==undefined?e.canvas:document.createElement("canvas"),s=a.width,l=a.height,c=Math.floor(s/2),f=Math.floor(l/2),p=0,d=0,u=s,h=l,m=1,v=a.getContext("2d",{alpha:e.alpha===true}),E=new THREE.Color(0),x=e.alpha===true?0:1,y=1,g=0,S=null,R=null,T=null,w=null,M=null,C=[],H,b,L,B,P,z,W,j,V,k=new THREE.Color,D=new THREE.Color,F=new THREE.Color,N=new THREE.Color,O={},A,I,G,U,q,J,K,Q=new THREE.Box2,X=new THREE.Box2,Y=new THREE.Box2,Z=new THREE.Color,$=new THREE.Color,_=new THREE.Color,ee=new THREE.Vector3,ie=new THREE.Vector3,te=new THREE.Vector3,re=new THREE.Matrix3;if(v.setLineDash===undefined){v.setLineDash=function(){}}this.domElement=a;this.autoClear=true;this.sortObjects=true;this.sortElements=true;this.info={render:{vertices:0,faces:0}};this.supportsVertexTextures=function(){};this.setFaceCulling=function(){};this.getContext=function(){return v};this.getContextAttributes=function(){return v.getContextAttributes()};this.getPixelRatio=function(){return m};this.setPixelRatio=function(e){if(e!==undefined)m=e};this.setSize=function(e,i,t){s=e*m;l=i*m;a.width=s;a.height=l;c=Math.floor(s/2);f=Math.floor(l/2);if(t!==false){a.style.width=e+"px";a.style.height=i+"px"}Q.min.set(-c,-f);Q.max.set(c,f);X.min.set(-c,-f);X.max.set(c,f);y=1;g=0;S=null;R=null;T=null;w=null;M=null;this.setViewport(0,0,e,i)};this.setViewport=function(e,i,t,r){p=e*m;d=i*m;u=t*m;h=r*m};this.setScissor=function(){};this.setScissorTest=function(){};this.setClearColor=function(e,i){E.set(e);x=i!==undefined?i:1;X.min.set(-c,-f);X.max.set(c,f)};this.setClearColorHex=function(e,i){console.warn("THREE.CanvasRenderer: .setClearColorHex() is being removed. Use .setClearColor() instead.");this.setClearColor(e,i)};this.getClearColor=function(){return E};this.getClearAlpha=function(){return x};this.getMaxAnisotropy=function(){return 0};this.clear=function(){if(X.isEmpty()===false){X.intersect(Q);X.expandByScalar(2);X.min.x=X.min.x+c;X.min.y=-X.min.y+f;X.max.x=X.max.x+c;X.max.y=-X.max.y+f;if(x<1){v.clearRect(X.min.x|0,X.max.y|0,X.max.x-X.min.x|0,X.min.y-X.max.y|0)}if(x>0){ve(THREE.NormalBlending);me(1);Se("rgba("+Math.floor(E.r*255)+","+Math.floor(E.g*255)+","+Math.floor(E.b*255)+","+x+")");v.fillRect(X.min.x|0,X.max.y|0,X.max.x-X.min.x|0,X.min.y-X.max.y|0)}X.makeEmpty()}};this.clearColor=function(){};this.clearDepth=function(){};this.clearStencil=function(){};this.render=function(e,a){if(a.isCamera===undefined){console.error("THREE.CanvasRenderer.render: camera is not an instance of THREE.Camera.");return}var m=e.background;if(m&&m.isColor){Se("rgb("+Math.floor(m.r*255)+","+Math.floor(m.g*255)+","+Math.floor(m.b*255)+")");v.fillRect(0,0,s,l)}else if(this.autoClear===true){this.clear()}i.info.render.vertices=0;i.info.render.faces=0;v.setTransform(u/s,0,0,-h/l,p,l-d);v.translate(c,f);t=o.projectScene(e,a,this.sortObjects,this.sortElements);r=t.elements;n=t.lights;re.getNormalMatrix(a.matrixWorldInverse);ne();for(var E=0,x=r.length;E<x;E++){var y=r[E];var g=y.material;if(g===undefined||g.opacity===0)continue;Y.makeEmpty();if(y instanceof THREE.RenderableSprite){H=y;H.x*=c;H.y*=f;ae(H,y,g)}else if(y instanceof THREE.RenderableLine){H=y.v1;b=y.v2;H.positionScreen.x*=c;H.positionScreen.y*=f;b.positionScreen.x*=c;b.positionScreen.y*=f;Y.setFromPoints([H.positionScreen,b.positionScreen]);if(Q.intersectsBox(Y)===true){se(H,b,y,g)}}else if(y instanceof THREE.RenderableFace){H=y.v1;b=y.v2;L=y.v3;if(H.positionScreen.z<-1||H.positionScreen.z>1)continue;if(b.positionScreen.z<-1||b.positionScreen.z>1)continue;if(L.positionScreen.z<-1||L.positionScreen.z>1)continue;H.positionScreen.x*=c;H.positionScreen.y*=f;b.positionScreen.x*=c;b.positionScreen.y*=f;L.positionScreen.x*=c;L.positionScreen.y*=f;if(g.overdraw>0){he(H.positionScreen,b.positionScreen,g.overdraw);he(b.positionScreen,L.positionScreen,g.overdraw);he(L.positionScreen,H.positionScreen,g.overdraw)}Y.setFromPoints([H.positionScreen,b.positionScreen,L.positionScreen]);if(Q.intersectsBox(Y)===true){le(H,b,L,0,1,2,y,g)}}X.union(Y)}v.setTransform(1,0,0,1,0,0)};function ne(){Z.setRGB(0,0,0);$.setRGB(0,0,0);_.setRGB(0,0,0);for(var e=0,i=n.length;e<i;e++){var t=n[e];var r=t.color;if(t.isAmbientLight){Z.add(r)}else if(t.isDirectionalLight){$.add(r)}else if(t.isPointLight){_.add(r)}}}function oe(e,i,t){for(var r=0,o=n.length;r<o;r++){var a=n[r];N.copy(a.color);if(a.isDirectionalLight){var s=ee.setFromMatrixPosition(a.matrixWorld).normalize();var l=i.dot(s);if(l<=0)continue;l*=a.intensity;t.add(N.multiplyScalar(l))}else if(a.isPointLight){var s=ee.setFromMatrixPosition(a.matrixWorld);var l=i.dot(ee.subVectors(s,e).normalize());if(l<=0)continue;l*=a.distance==0?1:1-Math.min(e.distanceTo(s)/a.distance,1);if(l==0)continue;l*=a.intensity;t.add(N.multiplyScalar(l))}}}function ae(e,i,t){me(t.opacity);ve(t.blending);var r=i.scale.x*c;var n=i.scale.y*f;var o=Math.sqrt(r*r+n*n);Y.min.set(e.x-o,e.y-o);Y.max.set(e.x+o,e.y+o);if(t.isSpriteMaterial){var a=t.map;if(a!==null){var s=O[a.id];if(s===undefined||s.version!==a.version){s=de(a);O[a.id]=s}if(s.canvas!==undefined){Se(s.canvas);var l=a.image;var p=l.width*a.offset.x;var d=l.height*a.offset.y;var u=l.width*a.repeat.x;var h=l.height*a.repeat.y;var m=r/u;var E=n/h;v.save();v.translate(e.x,e.y);if(t.rotation!==0)v.rotate(t.rotation);v.translate(-r/2,-n/2);v.scale(m,E);v.translate(-p,-d);v.fillRect(p,d,u,h);v.restore()}}else{Se(t.color.getStyle());v.save();v.translate(e.x,e.y);if(t.rotation!==0)v.rotate(t.rotation);v.scale(r,-n);v.fillRect(-.5,-.5,1,1);v.restore()}}else if(t.isSpriteCanvasMaterial){ge(t.color.getStyle());Se(t.color.getStyle());v.save();v.translate(e.x,e.y);if(t.rotation!==0)v.rotate(t.rotation);v.scale(r,n);t.program(v);v.restore()}else if(t.isPointsMaterial){Se(t.color.getStyle());v.save();v.translate(e.x,e.y);if(t.rotation!==0)v.rotate(t.rotation);v.scale(r*t.size,-n*t.size);v.fillRect(-.5,-.5,1,1);v.restore()}}function se(e,i,t,r){me(r.opacity);ve(r.blending);v.beginPath();v.moveTo(e.positionScreen.x,e.positionScreen.y);v.lineTo(i.positionScreen.x,i.positionScreen.y);if(r.isLineBasicMaterial){Ee(r.linewidth);xe(r.linecap);ye(r.linejoin);if(r.vertexColors!==THREE.VertexColors){ge(r.color.getStyle())}else{var n=t.vertexColors[0].getStyle();var o=t.vertexColors[1].getStyle();if(n===o){ge(n)}else{try{var a=v.createLinearGradient(e.positionScreen.x,e.positionScreen.y,i.positionScreen.x,i.positionScreen.y);a.addColorStop(0,n);a.addColorStop(1,o)}catch(s){a=n}ge(a)}}v.stroke();Y.expandByScalar(r.linewidth*2)}else if(r.isLineDashedMaterial){Ee(r.linewidth);xe(r.linecap);ye(r.linejoin);ge(r.color.getStyle());Re([r.dashSize,r.gapSize]);v.stroke();Y.expandByScalar(r.linewidth*2);Re([])}}function le(e,t,r,n,o,a,s,l){i.info.render.vertices+=3;i.info.render.faces++;me(l.opacity);ve(l.blending);B=e.positionScreen.x;P=e.positionScreen.y;z=t.positionScreen.x;W=t.positionScreen.y;j=r.positionScreen.x;V=r.positionScreen.y;ce(B,P,z,W,j,V);if((l.isMeshLambertMaterial||l.isMeshPhongMaterial||l.isMeshStandardMaterial)&&l.map===null){D.copy(l.color);F.copy(l.emissive);if(l.vertexColors===THREE.FaceColors){D.multiply(s.color)}k.copy(Z);ie.copy(e.positionWorld).add(t.positionWorld).add(r.positionWorld).divideScalar(3);oe(ie,s.normalModel,k);k.multiply(D).add(F);l.wireframe===true?fe(k,l.wireframeLinewidth,l.wireframeLinecap,l.wireframeLinejoin):pe(k)}else if(l.isMeshBasicMaterial||l.isMeshLambertMaterial||l.isMeshPhongMaterial||l.isMeshStandardMaterial){if(l.map!==null){var c=l.map.mapping;if(c===THREE.UVMapping){A=s.uvs;ue(B,P,z,W,j,V,A[n].x,A[n].y,A[o].x,A[o].y,A[a].x,A[a].y,l.map)}}else if(l.envMap!==null){if(l.envMap.mapping===THREE.SphericalReflectionMapping){te.copy(s.vertexNormalsModel[n]).applyMatrix3(re);I=.5*te.x+.5;G=.5*te.y+.5;te.copy(s.vertexNormalsModel[o]).applyMatrix3(re);U=.5*te.x+.5;q=.5*te.y+.5;te.copy(s.vertexNormalsModel[a]).applyMatrix3(re);J=.5*te.x+.5;K=.5*te.y+.5;ue(B,P,z,W,j,V,I,G,U,q,J,K,l.envMap)}}else{k.copy(l.color);if(l.vertexColors===THREE.FaceColors){k.multiply(s.color)}l.wireframe===true?fe(k,l.wireframeLinewidth,l.wireframeLinecap,l.wireframeLinejoin):pe(k)}}else if(l.isMeshNormalMaterial){te.copy(s.normalModel).applyMatrix3(re);k.setRGB(te.x,te.y,te.z).multiplyScalar(.5).addScalar(.5);l.wireframe===true?fe(k,l.wireframeLinewidth,l.wireframeLinecap,l.wireframeLinejoin):pe(k)}else{k.setRGB(1,1,1);l.wireframe===true?fe(k,l.wireframeLinewidth,l.wireframeLinecap,l.wireframeLinejoin):pe(k)}}function ce(e,i,t,r,n,o){v.beginPath();v.moveTo(e,i);v.lineTo(t,r);v.lineTo(n,o);v.closePath()}function fe(e,i,t,r){Ee(i);xe(t);ye(r);ge(e.getStyle());v.stroke();Y.expandByScalar(i*2)}function pe(e){Se(e.getStyle());v.fill()}function de(e){if(e.version===0||e instanceof THREE.CompressedTexture||e instanceof THREE.DataTexture){return{canvas:undefined,version:e.version}}var i=e.image;if(i.complete===false){return{canvas:undefined,version:0}}var t=e.wrapS===THREE.RepeatWrapping||e.wrapS===THREE.MirroredRepeatWrapping;var r=e.wrapT===THREE.RepeatWrapping||e.wrapT===THREE.MirroredRepeatWrapping;var n=e.wrapS===THREE.MirroredRepeatWrapping;var o=e.wrapT===THREE.MirroredRepeatWrapping;var a=document.createElement("canvas");a.width=i.width*(n?2:1);a.height=i.height*(o?2:1);var s=a.getContext("2d");s.setTransform(1,0,0,-1,0,i.height);s.drawImage(i,0,0);if(n===true){s.setTransform(-1,0,0,-1,i.width,i.height);s.drawImage(i,-i.width,0)}if(o===true){s.setTransform(1,0,0,1,0,0);s.drawImage(i,0,i.height)}if(n===true&&o===true){s.setTransform(-1,0,0,1,i.width,0);s.drawImage(i,-i.width,i.height)}var l="no-repeat";if(t===true&&r===true){l="repeat"}else if(t===true){l="repeat-x"}else if(r===true){l="repeat-y"}var c=v.createPattern(a,l);if(e.onUpdate)e.onUpdate(e);return{canvas:c,version:e.version}}function ue(e,i,t,r,n,o,a,s,l,c,f,p,d){var u=O[d.id];if(u===undefined||u.version!==d.version){u=de(d);O[d.id]=u}if(u.canvas!==undefined){Se(u.canvas)}else{Se("rgba( 0, 0, 0, 1)");v.fill();return}var h,m,E,x,y,g,S,R,T=d.offset.x/d.repeat.x,w=d.offset.y/d.repeat.y,M=d.image.width*d.repeat.x,C=d.image.height*d.repeat.y;a=(a+T)*M;s=(s+w)*C;l=(l+T)*M;c=(c+w)*C;f=(f+T)*M;p=(p+w)*C;t-=e;r-=i;n-=e;o-=i;l-=a;c-=s;f-=a;p-=s;S=l*p-f*c;if(S===0)return;R=1/S;h=(p*t-c*n)*R;m=(p*r-c*o)*R;E=(l*n-f*t)*R;x=(l*o-f*r)*R;y=e-h*a-E*s;g=i-m*a-x*s;v.save();v.transform(h,m,E,x,y,g);v.fill();v.restore()}function he(e,i,t){var r=i.x-e.x,n=i.y-e.y,o=r*r+n*n,a;if(o===0)return;a=t/Math.sqrt(o);r*=a;n*=a;i.x+=r;i.y+=n;e.x-=r;e.y-=n}function me(e){if(y!==e){v.globalAlpha=e;y=e}}function ve(e){if(g!==e){if(e===THREE.NormalBlending){v.globalCompositeOperation="source-over"}else if(e===THREE.AdditiveBlending){v.globalCompositeOperation="lighter"}else if(e===THREE.SubtractiveBlending){v.globalCompositeOperation="darker"}else if(e===THREE.MultiplyBlending){v.globalCompositeOperation="multiply"}g=e}}function Ee(e){if(T!==e){v.lineWidth=e;T=e}}function xe(e){if(w!==e){v.lineCap=e;w=e}}function ye(e){if(M!==e){v.lineJoin=e;M=e}}function ge(e){if(S!==e){v.strokeStyle=e;S=e}}function Se(e){if(R!==e){v.fillStyle=e;R=e}}function Re(e){if(C.length!==e.length){v.setLineDash(e);C=e}}};